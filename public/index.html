<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CYRUS PRE BOND TERMINAL</title>
  <!-- Responsive Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Font Awesome (For Social & Icon Links) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    integrity="sha512-Fo3rlrZj/kTcJrQykN+m8Qx+aVxjU3e2BmVlzLQjvqdMZTH7V6QthGJbfhGVqF5tB3Vu8uJ+8j0+LZj3R+3p1Q=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- If needed, Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --terminal-green: #00b894;
      --terminal-green-glow: rgba(0, 184, 148, 0.4);
      --highlight: #00b894;
      --highlight-light: #66b0ff;
      --text-color: #39FF14;
      --background: #121212;
      --card-bg: #1e1e1e;
      --button-color: #2c2c2c;
      --border-color: #333333;
      --button-hover: #00C853;
      --notification-bg: rgba(0, 184, 148, 0.9);
      --notification-text: #121212;
      --shadow-color: rgba(0, 184, 148, 0.5);

      /* Right side sidebars: trending & migrated & video & referral */
      --trend-bg: linear-gradient(135deg, #5f5fd5, #d55fff, #ff5fd5);
      --trend-border: #ff98e2;
      --trend-text: #fcecff;

      /* Migrated styling */
      --migrated-bg: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.05),
        rgba(0, 255, 160, 0.05),
        rgba(0, 90, 255, 0.05),
        rgba(255, 255, 255, 0.05)
      );
      --migrated-border: rgba(255, 255, 255, 0.2);
      --migrated-text: #ffffff;

      /* Glow effect for the "Show Trending" button */
      --glow-animation: glow 2s infinite alternate;
    }

    @keyframes glow {
      from {
        box-shadow: 0 0 8px #ff6b6b, 0 0 16px #ff6b6b;
      }
      to {
        box-shadow: 0 0 8px #66b0ff, 0 0 16px #66b0ff;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text-color);

      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      grid-template-rows: auto auto 1fr auto;
      gap: 1rem;
      padding: 1rem;
      min-height: 100vh;
    }

    /* Title */
    .title-container {
      grid-column: 1 / -1;
      margin-bottom: 1rem;
      text-align: center;
      padding: 1rem 0;
    }
    .glowing-title {
      font-family: 'Share Tech Mono', monospace;
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--highlight);
      text-shadow:
        0 0 10px var(--terminal-green-glow),
        0 0 20px var(--terminal-green-glow),
        0 0 40px var(--terminal-green-glow);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% {
        text-shadow:
          0 0 10px var(--terminal-green-glow),
          0 0 20px var(--terminal-green-glow),
          0 0 40px var(--terminal-green-glow);
      }
      50% {
        text-shadow:
          0 0 20px var(--terminal-green-glow),
          0 0 30px var(--terminal-green-glow),
          0 0 50px var(--terminal-green-glow);
      }
    }

    /* Header (Wallet Connect) */
    .header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .wallet-button {
      background: var(--button-color);
      color: var(--highlight);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-family: 'Share Tech Mono', monospace;
    }
    .wallet-button:hover {
      background: var(--button-hover);
    }

    /* Create Prebond Token => left, fixed max-height */
    .create-post-container {
      grid-column: 1 / 2;
      grid-row: 3 / 4;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 600px;
      overflow-y: auto;
    }
    .create-post-container h2 {
      color: var(--highlight);
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 1rem;
    }

    /* All Tokens => Middle, fixed max-height */
    .posts-container {
      grid-column: 2 / 3;
      grid-row: 3 / 4;
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      max-height: 600px;
      overflow-y: auto;
    }
    .posts-container h2 {
      color: var(--highlight);
      margin-bottom: 1rem;
      font-family: 'Share Tech Mono', monospace;
    }

    /* Right container => toggles for trending/migrated/video/referral */
    .right-container {
      grid-column: 3 / 4;
      grid-row: 3 / 4;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .toggle-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .toggle-btn {
      background: var(--button-color);
      color: var(--highlight);
      border: none;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
      transition: background 0.3s ease;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      justify-content: center;
    }
    .toggle-btn:hover {
      background: var(--button-hover);
    }
    /* Show trending => add neon glow animation */
    #showTrendingBtn {
      animation: var(--glow-animation);
    }

    /* Hidden sidebars by default: trending, migrated, video, referral */
    .trending-container,
    .migrated-container,
    .video-container,
    .referral-container {
      display: none;
      max-height: 300px;
      overflow-y: auto;
      border-radius: 15px;
      box-shadow: 0 4px 6px var(--shadow-color);
      padding: 1.5rem;
    }

    .video-container {
      background: var(--card-bg);
    }
    .video-container h2 {
      font-family: 'Share Tech Mono', monospace;
      color: var(--highlight);
      margin-bottom: 0.5rem;
      text-align: center;
    }
    video {
      width: 100%;
      height: auto;
      border-radius: 8px;
      outline: none;
      object-fit: cover;
    }

    /* Trending */
    .trending-container {
      background: var(--trend-bg);
      background-size: 300% 300%;
      animation: colorPulse 5s linear infinite;
    }
    @keyframes colorPulse {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    .trending-container h2 {
      color: var(--trend-text);
      margin-bottom: 1rem;
      font-family: 'Share Tech Mono', monospace;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
      text-align: center;
    }
    .trending-item {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid var(--trend-border);
      border-radius: 10px;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      animation: slideIn 0.3s ease forwards;
      opacity: 0;
      font-family: 'Share Tech Mono', monospace;
      color: var(--trend-text);
      cursor: pointer;
    }

    /* Migrated */
    .migrated-container {
      background: var(--migrated-bg);
      border: 2px solid var(--migrated-border);
    }
    .migrated-container h2 {
      color: var(--migrated-text);
      margin-bottom: 1rem;
      font-family: 'Share Tech Mono', monospace;
      text-align: center;
    }
    .migrated-item {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.07);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: 'Share Tech Mono', monospace;
      color: var(--migrated-text);
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .migrated-item:hover {
      transform: translateX(-4px);
      background: rgba(255, 255, 255, 0.1);
    }
    .migrated-item .stats-line {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-bottom: 0.3rem;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Referral container => show/hide */
    .referral-container {
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      color: var(--highlight);
    }
    .referral-container h2 {
      text-align: center;
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 1rem;
    }
    .referral-container p {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .referral-link {
      background: var(--button-color);
      padding: 0.5rem;
      border-radius: 6px;
      color: var(--text-color);
      word-wrap: break-word;
      margin-bottom: 0.5rem;
    }
    .referral-points {
      font-size: 0.9rem;
      margin: 0.5rem 0;
    }

    /* Middle container => post items */
    .post-item {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      display: grid;
      grid-template-columns: 1fr 150px;
      gap: 1.5rem;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 6px var(--shadow-color);
    }
    .post-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px var(--shadow-color);
    }
    .post-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, var(--highlight), var(--highlight-light));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }
    .post-item:hover::before {
      transform: scaleX(1);
    }
    .post-content {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .post-title {
      font-size: 1.9rem;
      font-weight: 600;
      color: var(--highlight);
      text-shadow: 0 0 10px var(--terminal-green-glow);
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s ease;
    }
    .post-title:hover {
      transform: translateX(5px);
      text-shadow: 0 0 15px var(--terminal-green-glow);
    }
    .post-ticker {
      color: var(--highlight);
      font-size: 1.2rem;
      font-weight: 500;
      text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
      transition: all 0.3s ease;
      font-family: 'Share Tech Mono', monospace;
    }
    .migrated-badge {
      margin-left: 0.5rem;
      font-size: 0.9rem;
      color: #ff00ff; /* neon pink star */
      text-shadow: 0 0 6px #ff00ff, 0 0 12px #ff00ff;
    }

    .post-description {
      color: var(--text-color);
      font-size: 0.9rem;
      line-height: 1.6;
      margin: 0.5rem 0;
      opacity: 0.9;
      font-family: 'Share Tech Mono', monospace;
    }
    .post-image {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .post-image:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    .post-stats {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    .stat-badge {
      background: var(--button-color);
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      transition: all 0.3s ease;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
    }
    .progress-container {
      margin-top: 1rem;
      position: relative;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--button-color);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(
        90deg,
        var(--highlight),
        var(--highlight-light),
        var(--highlight)
      );
      background-size: 200% 100%;
      animation: gradientMove 2s linear infinite;
      transition: width 0.3s ease;
    }
    @keyframes gradientMove {
      0% {
        background-position: 100% 0;
      }
      100% {
        background-position: -100% 0;
      }
    }
    .progress-text {
      position: absolute;
      right: 0;
      top: -1.5rem;
      font-size: 0.8rem;
      color: var(--highlight);
      font-family: 'Share Tech Mono', monospace;
    }
    .upvote-progress-container {
      margin-top: 1rem;
      position: relative;
    }
    .upvote-progress-bar {
      width: 100%;
      height: 4px;
      background: var(--button-color);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }
    .upvote-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff4757, #ff6b6b, #ff4757);
      background-size: 200% 100%;
      animation: gradientMove 2s linear infinite;
      transition: width 0.3s ease;
    }
    .upvote-progress-text {
      position: absolute;
      right: 0;
      top: -1.5rem;
      font-size: 0.8rem;
      color: #ff6b6b;
      font-family: 'Share Tech Mono', monospace;
    }

    .interaction-interface {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .commit-btn,
    .refund-btn,
    .transfer-btn,
    .upvote-btn {
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }
    .commit-btn {
      background: var(--highlight);
      color: var(--background);
    }
    .commit-btn:hover {
      background: var(--highlight-light);
    }
    .refund-btn {
      background: #ff6b6b;
      color: #121212;
    }
    .refund-btn:hover {
      background: #ff2f47;
    }
    .transfer-btn {
      background: #6b5fff;
      color: #fff;
    }
    .transfer-btn:hover {
      background: #836bff;
    }
    .upvote-btn {
      background: var(--button-color);
      color: var(--highlight);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .upvote-btn:hover {
      background: var(--button-hover);
    }
    .upvote-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Modals => post, commit, AI agent, logs, pdf, referral */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-content {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 0 20px var(--shadow-color);
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--highlight);
      font-size: 1.5rem;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
      transition: all 0.3s ease;
    }
    .close-modal:hover {
      transform: rotate(90deg);
      color: var(--highlight-light);
    }

    .commit-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .commit-modal-content {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      width: 90%;
      max-width: 400px;
      position: relative;
      box-shadow: 0 0 20px var(--shadow-color);
      animation: modalSlideIn 0.3s ease;
      text-align: center;
      font-family: 'Share Tech Mono', monospace;
    }
    .close-commit-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: var(--highlight);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Share Tech Mono', monospace;
    }
    .close-commit-modal:hover {
      transform: rotate(90deg);
      color: var(--highlight-light);
    }

    .modal-content.browser-like {
      border: 2px solid var(--highlight);
      box-shadow: 0 0 30px var(--highlight);
    }
    .agent-logs {
      max-height: 300px;
      overflow-y: auto;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 0.9rem;
      font-family: 'Share Tech Mono', monospace;
    }

    /* Post Modal => comments & nested replies & committed wallets */
    .chat-container {
      margin-top: 2rem;
      background: var(--background);
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 4px 6px var(--shadow-color);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .chat-messages {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      border-right: 1px solid var(--border-color);
    }
    .chat-committed-wallets {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--card-bg);
      border-radius: 8px;
    }
    .chat-committed-wallets h4 {
      color: var(--highlight);
      margin-bottom: 0.5rem;
      font-family: 'Share Tech Mono', monospace;
    }
    .chat-message {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      position: relative;
    }
    .chat-message-reply {
      margin-left: 2rem;
      border-left: 2px solid var(--highlight);
      padding-left: 1rem;
    }
    .chat-message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      color: var(--highlight);
      font-family: 'Share Tech Mono', monospace;
    }
    .chat-message-content {
      color: var(--text-color);
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .reply-button {
      background: var(--button-color);
      color: var(--highlight);
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Share Tech Mono', monospace;
    }
    .reply-button:hover {
      background: var(--card-bg);
      transform: translateY(-2px);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    .chat-input-container {
      grid-column: 1 / 3;
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .chat-input {
      flex: 1;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 0.75rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'Share Tech Mono', monospace;
    }
    .chat-input:focus {
      outline: none;
      border-color: var(--highlight);
      box-shadow: 0 0 0 2px var(--terminal-green-glow);
    }

    /* Notification */
    .notification {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--notification-bg);
      color: var(--notification-text);
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow-color);
      z-index: 99999;
      font-family: 'Share Tech Mono', monospace;
      display: none;
    }

    /* Footer with social & docs */
    .footer {
      grid-column: 1 / -1;
      grid-row: 4 / 5;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      margin-top: 1rem;
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }
    .footer a {
      color: var(--highlight);
      font-family: 'Share Tech Mono', monospace;
      text-decoration: none;
      transition: color 0.3s ease;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .footer a:hover {
      color: var(--highlight-light);
    }
    .docs-btn {
      background: var(--button-color);
      color: var(--highlight);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Share Tech Mono', monospace;
      transition: background 0.3s ease;
    }
    .docs-btn:hover {
      background: var(--button-hover);
    }

    /* Responsive for large tablets and below */
    @media (max-width:1200px){
      body {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto 1fr auto;
      }
      .create-post-container {
        grid-column:1 / -1;
      }
      .posts-container {
        grid-column:1 / -1;
      }
      .right-container {
        grid-column:1 / -1;
      }
    }

    /* Mobile (below 768px) => hide advertisement sidebar, rearrange layout */
    @media (max-width:768px){
      body {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr auto auto;
      }
      .create-post-container,
      .posts-container,
      .right-container {
        grid-column:1 / -1;
        grid-row:auto;
        /* Use 'order' to set the sequence top-to-bottom */
      }
      /* 1) create token, 2) all tokens, 3) sidebars */
      .create-post-container {
        order: 1;
      }
      .posts-container {
        order: 2;
      }
      .right-container {
        order: 3;
      }

      .post-item {
        grid-template-columns:1fr;
      }
      .post-image {
        width:100%; 
        height:auto;
      }
      .chat-container {
        display: block;
      }
      .chat-messages {
        border-right:none; 
        margin-bottom:1rem;
      }
      .chat-input-container {
        grid-column:1 / 2;
      }

      /* Hide the advertisement (video) on screens < 768px by default */
      .video-container {
        display: none !important;
      }
    }

    /* Additional small-device support (below 480px) */
    @media (max-width:480px){
      .title-container {
        padding: 0.5rem 0;
      }
      .glowing-title {
        font-size: 1.8rem;
      }
      .header {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }
      .create-post-container,
      .posts-container,
      .right-container {
        max-height: 500px; /* Adjust for smaller screens */
      }
      .create-agent-btn {
        font-size: 0.8rem;
        padding: 0.6rem 1rem;
      }
      .toggle-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.7rem;
      }
      .post-title {
        font-size: 1.4rem;
      }
      .post-ticker {
        font-size: 1rem;
      }
      .post-description {
        font-size: 0.8rem;
      }
      .chat-container {
        grid-template-columns: 1fr;
        grid-row-gap: 1rem;
      }
      .chat-messages,
      .chat-committed-wallets {
        max-height: 200px;
      }
      .footer a {
        font-size: 0.8rem;
      }
      .commit-btn, .refund-btn, .transfer-btn, .upvote-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Title -->
  <div class="title-container">
    <h1 class="glowing-title">CYRUS PRE BOND TERMINAL</h1>
  </div>

  <!-- Header -->
  <div class="header">
    <button id="walletButton" class="wallet-button">Connect Wallet</button>
  </div>

  <!-- Left: Create Prebond Token -->
  <div class="create-post-container">
    <h2>Create Prebond Token</h2>
    <!-- Your form, inputs, etc. remain the same -->
    <form id="tokenCreationForm" class="token-creation-form">
      <!-- form groups here -->
    </form>
    <button class="create-agent-btn" id="openAIAgentBtn">Create X AI Agent</button>
  </div>

  <!-- Middle: All Tokens -->
  <div class="posts-container" id="posts-container">
    <h2>All Tokens</h2>
    <!-- Tokens displayed here (JS) -->
    <div id="allTokensList"></div>
  </div>

  <!-- Right side => toggles for trending / migrated / referral / video -->
  <div class="right-container">
    <div class="toggle-buttons">
      <button class="toggle-btn" id="showTrendingBtn"><i class="fas fa-fire"></i> Show Trending</button>
      <button class="toggle-btn" id="showMigratedBtn"><i class="fas fa-exchange-alt"></i> Show Migrated</button>
      <button class="toggle-btn" id="showReferralBtn"><i class="fas fa-link"></i> Show Referral</button>
    </div>

    <!-- Trend -->
    <div class="trending-container" id="trendingContainer">
      <h2>Trending Tokens</h2>
      <!-- trending items go here -->
    </div>
    <!-- Migrated -->
    <div class="migrated-container" id="migratedContainer">
      <h2>Migrated Prebond Tokens</h2>
      <!-- migrated items go here -->
    </div>
    <!-- Video => loop ad, hidden by default (or toggled), same 300px max-height -->
    <div class="video-container" id="videoContainer">
      <h2>Advertisement</h2>
      <video autoplay loop muted>
        <source src="/videos/demo.mp4" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>
    <!-- Referral container -->
    <div class="referral-container" id="referralContainer">
      <h2>Referral Link</h2>
      <p>Share your referral link below to earn Cyrus Points!</p>
      <div class="referral-link" id="referralLink">Loading...</div>
      <p class="referral-points" id="referralPoints">You have 0 Cyrus Points.</p>
    </div>
  </div>

  <!-- AI Agent Modal -->
  <div class="modal-overlay" id="aiAgentModal">
    <div class="modal-content browser-like">
      <button class="close-modal" id="closeAIAgentModal">&times;</button>
      <h2 style="color:var(--highlight); font-family:'Share Tech Mono', monospace; margin-bottom:1rem;">
        AI Agent Management
      </h2>
      <!-- ... -->
    </div>
  </div>

  <!-- AI Agent Logs Modal -->
  <div class="modal-overlay" id="agentLogsModal">
    <div class="modal-content browser-like">
      <button class="close-modal" id="closeAgentLogsModal">&times;</button>
      <div class="agent-logs" id="agentLogs"></div>
    </div>
  </div>

  <!-- Post Modal => comments & nested replies, plus committed wallets in same area -->
  <div class="modal-overlay" id="modal">
    <div class="modal-content" id="modalContent">
      <button class="close-modal" id="closeModal">&times;</button>
      <!-- Dynamically injected content -->
    </div>
  </div>

  <!-- Commit Modal -->
  <div class="commit-modal-overlay" id="commitModal">
    <div class="commit-modal-content">
      <button class="close-commit-modal" id="closeCommitModal">&times;</button>
      <h3>Select SOL Amount to Commit</h3>
      <div class="preset-amounts">
        <button class="preset-btn" data-amount="0.25">0.25 SOL</button>
        <button class="preset-btn" data-amount="0.5">0.5 SOL</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Footer with social & docs -->
  <div class="footer">
    <a href="https://x.com/niotheniner" target="_blank">
      <i class="fab fa-twitter"></i> X
    </a>
    <a href="https://github.com/DylanPort/cyrus-prebondterminal/" target="_blank">
      <i class="fab fa-github"></i> GitHub
    </a>
    <a href="https://t.me/cyrusterminal" target="_blank">
      <i class="fab fa-telegram"></i> Telegram
    </a>
    <a href="https://dexscreener.com/solana/hmbm3hpj8j8kd5kbzlemp5nzbhe2hvvzsndwomurznor" target="_blank">
      <i class="fas fa-chart-line"></i> DexScreener
    </a>
    <a href="https://cyruswhitepaper.fun" target="_blank">
      <i class="fab fa-telegram"></i> Docs
    </a>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // DOM references
      const walletButton = document.getElementById("walletButton");

      // create token form
      const tokenCreationForm = document.getElementById("tokenCreationForm");
      const tokenNameInput = document.getElementById("tokenNameInput");
      const tokenSymbolInput = document.getElementById("tokenSymbolInput");
      const tokenImageInput = document.getElementById("tokenImageInput");
      const twitterLinkInput = document.getElementById("twitterLinkInput");
      const websiteLinkInput = document.getElementById("websiteLinkInput");
      const telegramLinkInput = document.getElementById("telegramLinkInput");
      const commit25Btn = document.getElementById("commit25Btn");
      const commit50Btn = document.getElementById("commit50Btn");
      const tokenDescInput = document.getElementById("tokenDescInput");

      // All tokens container & list area
      const allTokensList = document.getElementById("allTokensList");

      // Right toggles (trending, migrated, referral, video)
      const showTrendingBtn = document.getElementById("showTrendingBtn");
      const showMigratedBtn = document.getElementById("showMigratedBtn");
      const showReferralBtn = document.getElementById("showReferralBtn");

      const trendingContainer = document.getElementById("trendingContainer");
      const migratedContainer = document.getElementById("migratedContainer");
      const referralContainer = document.getElementById("referralContainer");
      const referralLink = document.getElementById("referralLink");
      const referralPoints = document.getElementById("referralPoints");

      // Modals
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modalContent");
      const commitModal = document.getElementById("commitModal");
      const closeCommitModal = document.getElementById("closeCommitModal");

      // AI Agent
      const openAIAgentBtn = document.getElementById("openAIAgentBtn");
      const aiAgentModal = document.getElementById("aiAgentModal");
      const closeAIAgentModal = document.getElementById("closeAIAgentModal");
      const aiAgentCreationForm = document.getElementById("aiAgentCreationForm");
      const agentsList = document.getElementById("agentsList");

      // AI logs
      const agentLogsModal = document.getElementById("agentLogsModal");
      const agentLogs = document.getElementById("agentLogs");
      const closeAgentLogsModal = document.getElementById("closeAgentLogsModal");

      // Notification
      const notification = document.getElementById("notification");

      // local state
      let walletId = localStorage.getItem("walletId") || null;
      let tokens = [];
      let userBalance = 1000;
      let immediateCommitAmount = null;
      let currentPostId = null;
      let referralPointsValue = 0; // for referral display

      // Helper for notifications
      function showNotification(msg, isError=false){
        notification.textContent= msg;
        notification.style.backgroundColor= isError ? 'rgba(255,0,0,0.9)' : 'var(--notification-bg)';
        notification.style.color= isError ? '#fff' : 'var(--notification-text)';
        notification.style.display='block';
        setTimeout(()=>{notification.style.display='none';},3000);
      }

      /* WALLET CONNECT */
      walletButton.addEventListener("click", async ()=>{
        if(!walletId){
          if(window.solana && window.solana.isPhantom){
            try{
              const resp= await window.solana.connect();
              walletId = resp.publicKey.toString();
              localStorage.setItem("walletId", walletId);
              walletButton.textContent="Disconnect Wallet";
              showNotification("Wallet connected successfully!");
              fetchTokens();
              fetchAgents();
              generateReferralLink();
            } catch(err){
              showNotification("Failed to connect wallet",true);
            }
          } else {
            showNotification("Phantom Wallet not found. Install Phantom to connect.",true);
          }
        } else {
          try{
            await window.solana.disconnect();
            walletId=null;
            localStorage.removeItem("walletId");
            walletButton.textContent="Connect Wallet";
            showNotification("Wallet disconnected.");
            fetchTokens();
            agentsList.innerHTML="<p>Please connect your wallet to view AI Agents.</p>";
          } catch(err){
            showNotification("Failed to disconnect wallet",true);
          }
        }
      });

      /* CREATE TOKEN => fetchTokens on success so they appear */
      tokenCreationForm.addEventListener("submit", async e=>{
        e.preventDefault();
        const name = tokenNameInput.value.trim();
        const symbol = tokenSymbolInput.value.trim().toUpperCase();
        const twitter = twitterLinkInput.value.trim();
        const website = websiteLinkInput.value.trim();
        const telegram = telegramLinkInput.value.trim();

        // check 200-word max in description
        function countWords(str){
          return str.trim().split(/\s+/).length;
        }
        const descText= tokenDescInput.value.trim();
        if(countWords(descText) > 200){
          showNotification("Description is too long! Max 200 words.",true);
          return;
        }

        if(!name || !symbol){
          showNotification("Please fill in the required fields: Token Name, Symbol.",true);
          return;
        }
        const file= tokenImageInput.files[0];
        if(!file){
          showNotification("Please upload an image for your token.",true);
          return;
        }
        if(file.size>2*1024*1024){
          showNotification("Image file exceeds 2MB limit.",true);
          return;
        }

        const reader= new FileReader();
        reader.readAsDataURL(file);
        reader.onload= async ()=>{
          const base64Image= reader.result;
          try{
            const res= await fetch("/api/tokens", {
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({
                title:name,
                ticker:symbol,
                description: descText || `Description for ${name}`,
                imageUrl: base64Image,
                twitterLink:twitter||null,
                websiteLink:website||null,
                telegramLink:telegram||null
              })
            });
            const data= await res.json();
            if(data.success){
              showNotification(`Token ${symbol} created successfully!`);
              tokenCreationForm.reset();
              if(immediateCommitAmount){
                await commitSol(data.token.id, immediateCommitAmount);
                immediateCommitAmount= null;
              }
              // Refresh tokens so the new one appears
              fetchTokens();
            } else {
              showNotification(data.message,true);
            }
          } catch(e){
            showNotification("Error creating token",true);
          }
        };
        reader.onerror= ()=>{
          showNotification("Error reading the image file.",true);
        };
      });

      // optional immediate commit
      commit25Btn.addEventListener("click", ()=>{
        immediateCommitAmount= 0.25;
        showNotification("Will commit 0.25 SOL immediately after token creation.");
      });
      commit50Btn.addEventListener("click", ()=>{
        immediateCommitAmount= 0.5;
        showNotification("Will commit 0.5 SOL immediately after token creation.");
      });

      /* Toggling sidebars */
      showTrendingBtn.addEventListener("click", ()=>{
        trendingContainer.style.display= trendingContainer.style.display==='none' ? 'block':'none';
        if(trendingContainer.style.display==='block') loadTrending();
      });
      showMigratedBtn.addEventListener("click", ()=>{
        migratedContainer.style.display= migratedContainer.style.display==='none' ? 'block':'none';
        if(migratedContainer.style.display==='block') loadMigrated();
      });
      showReferralBtn.addEventListener("click", ()=>{
        referralContainer.style.display= referralContainer.style.display==='none' ? 'block':'none';
        if(referralContainer.style.display==='block') generateReferralLink();
      });

      /* REFERRAL link & points */
      function generateReferralLink(){
        if(!walletId){
          referralLink.textContent= "Connect wallet first!";
          referralPoints.textContent= "You have 0 Cyrus Points.";
          return;
        }
        const link= `https://cyrus-terminal.fun/?ref=${walletId}`;
        referralLink.textContent= link;
        referralPoints.textContent= `You have ${referralPointsValue} Cyrus Points.`;
      }

      /* FETCH TOKENS */
      async function fetchTokens(){
        console.log("Fetching all tokens from server...");
        try{
          const res= await fetch("/api/tokens");
          const data= await res.json();
          if(data.success){
            tokens= data.tokens;
            userBalance= data.userBalance;
            renderTokens();
          } else {
            showNotification("Failed to fetch tokens.",true);
          }
        } catch(e){
          showNotification("Error fetching tokens from server.",true);
        }
      }

      function renderTokens(){
        allTokensList.innerHTML= '';
        tokens.forEach(tok=>{
          allTokensList.appendChild(createPostElement(tok));
        });
      }

      function createPostElement(token){
        const wrapper= document.createElement("div");
        wrapper.classList.add("post-item");

        const commitPct= token.solTarget>0 ? Math.min(100, (token.collectiveSOL/token.solTarget*100).toFixed(2)) : 0;
        const upvotePct= token.upvotes >= 100 ? 100 : token.upvotes;
        const migratedBadge= token.migrated ? ` <span class="migrated-badge">★</span>` : '';

        // check if user has committed
        let userHasCommitted= false;
        if(token.committedWallets && walletId){
          userHasCommitted= token.committedWallets.some(c=> c.walletId=== walletId);
        }
        let commitBtnHTML= '';
        if(commitPct<100 && !userHasCommitted){
          commitBtnHTML= `<button class="commit-btn" data-id="${token.id}">Commit</button>`;
        }
        let upvoteBtnHTML= `<button class="upvote-btn ${token.upvotedWallets && token.upvotedWallets.includes(walletId)? 'disabled':''}" data-id="${token.id}">
          <i class="fas fa-thumbs-up"></i> Upvote
        </button>`;
        let refundBtnHTML= '';
        if(userHasCommitted && commitPct<100){
          refundBtnHTML= `<button class="refund-btn" data-id="${token.id}">Refund SOL</button>`;
        }
        let transferBtnHTML= '';
        if(token.migrated){
          transferBtnHTML= `<button class="transfer-btn" data-id="${token.id}">Transfer Tokens</button>`;
        }

        wrapper.innerHTML=`
          <div class="post-content">
            <div class="post-title">${token.title}${migratedBadge}</div>
            <div class="post-ticker">${token.ticker}</div>
            <div class="post-description">${token.description}</div>
            ${(token.twitterLink||token.websiteLink||token.telegramLink)?`
              <div class="form-group">
                ${token.twitterLink? `<a href="${token.twitterLink}" target="_blank" class="form-label"><i class="fab fa-twitter"></i> Twitter</a>`:''}
                ${token.websiteLink? `<a href="${token.websiteLink}" target="_blank" class="form-label"><i class="fas fa-globe"></i> Website</a>`:''}
                ${token.telegramLink? `<a href="${token.telegramLink}" target="_blank" class="form-label"><i class="fab fa-telegram"></i> Telegram</a>`:''}
              </div>
            `:''}
            <div class="post-stats">
              <div class="stat-badge" title="Upvotes">
                <span class="stat-icon">↑</span>
                <span>${token.upvotes||0}</span>
              </div>
              <div class="stat-badge" title="Comments">
                <span class="stat-icon">💬</span>
                <span>${token.comments? token.comments.length : 0}</span>
              </div>
              <div class="stat-badge" title="Views">
                <span class="stat-icon">👁️</span>
                <span>${token.views||0}</span>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width:${commitPct}%"></div>
              </div>
              <div class="progress-text">${commitPct}%</div>
            </div>
            <div class="terminal-status">
              ${commitPct<100 ? `Commit Progress: ${token.collectiveSOL}/${token.solTarget} SOL`: 'SOL target reached! 🎉'}
            </div>
            <div class="upvote-progress-container">
              <div class="upvote-progress-bar">
                <div class="upvote-progress-fill" style="width:${upvotePct}%"></div>
              </div>
              <div class="upvote-progress-text">${token.upvotes} Upvotes</div>
            </div>
            <div class="interaction-interface">
              ${commitBtnHTML}
              ${upvoteBtnHTML}
              ${refundBtnHTML}
              ${transferBtnHTML}
            </div>
          </div>
          <img
            src="${token.imageUrl}"
            alt="${token.title}"
            class="post-image"
            onerror="this.onerror=null;this.src='public/images/placeholder.png'"
          />
        `;

        // handle clicks on the wrapper (excluding specific buttons)
        wrapper.addEventListener("click", e=>{
          if(
            e.target.classList.contains("commit-btn") ||
            e.target.classList.contains("upvote-btn") ||
            e.target.classList.contains("refund-btn") ||
            e.target.classList.contains("transfer-btn") ||
            e.target.closest(".commit-btn") ||
            e.target.closest(".upvote-btn") ||
            e.target.closest(".refund-btn") ||
            e.target.closest(".transfer-btn")
          ){
            return;
          }
          showPostModal(token.id);
        });

        // commit button
        const cBtn= wrapper.querySelector(".commit-btn");
        if(cBtn){
          cBtn.addEventListener("click", ev=>{
            ev.stopPropagation();
            if(!walletId){
              showNotification("Please connect your wallet to commit.",true);
              return;
            }
            currentPostId= token.id;
            commitModal.style.display="flex";
          });
        }
        // upvote button
        const uBtn= wrapper.querySelector(".upvote-btn");
        if(uBtn && !uBtn.classList.contains("disabled")){
          uBtn.addEventListener("click", async ev=>{
            ev.stopPropagation();
            if(!walletId){
              showNotification("Please connect your wallet to upvote.",true);
              return;
            }
            await upvoteToken(token.id);
          });
        }
        // refund button
        const rBtn= wrapper.querySelector(".refund-btn");
        if(rBtn){
          rBtn.addEventListener("click", async ev=>{
            ev.stopPropagation();
            if(!walletId){
              showNotification("Please connect your wallet to refund.",true);
              return;
            }
            await refundSol(token.id);
          });
        }
        // transfer button
        const tBtn= wrapper.querySelector(".transfer-btn");
        if(tBtn){
          tBtn.addEventListener("click", ev=>{
            ev.stopPropagation();
            showNotification(`Transferring tokens for ${token.ticker} (Not implemented)`, false);
          });
        }
        return wrapper;
      }

      /* SHOW POST MODAL => includes commited wallets & comments */
      function showPostModal(tokenId){
        const token= tokens.find(t=> t.id===tokenId);
        if(!token) return;
        modalContent.innerHTML=`
          <button class="close-modal" id="closeModal">&times;</button>
          <h2>${token.title}${token.migrated? `<span class="migrated-badge">★</span>`:''}</h2>
          <img
            src="${token.imageUrl}"
            alt="${token.title}"
            style="max-width:40%; border-radius:10px; margin-bottom:1rem; float:left; margin-right:1rem;"
          />
          <p>${token.description}</p>
          ${(token.twitterLink||token.websiteLink||token.telegramLink)?`
            <div class="form-group" style="clear:both; margin-top:1rem;">
              ${token.twitterLink? `<a href="${token.twitterLink}" target="_blank" class="form-label"><i class="fab fa-twitter"></i> Twitter</a><br>`:''}
              ${token.websiteLink? `<a href="${token.websiteLink}" target="_blank" class="form-label"><i class="fas fa-globe"></i> Website</a><br>`:''}
              ${token.telegramLink? `<a href="${token.telegramLink}" target="_blank" class="form-label"><i class="fab fa-telegram"></i> Telegram</a><br>`:''}
            </div>
          `:''}
          <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-committed-wallets" id="committedWallets">
              <h4>Committed Wallets</h4>
            </div>
            <div class="chat-input-container">
              <input type="text" id="chatInput" class="chat-input" placeholder="Add a comment..."/>
              <button id="sendComment" class="submit-btn">Send</button>
            </div>
          </div>
        `;
        modal.style.display="flex";
        document.getElementById("closeModal").addEventListener("click",()=>{
          modal.style.display="none";
        });
        loadChatMessages(tokenId, token.comments||[]);
        loadCommittedWallets(token);

        // handle new comment
        document.getElementById("sendComment").addEventListener("click", async()=>{
          const text= document.getElementById("chatInput").value.trim();
          if(!text) return;
          if(!walletId){
            showNotification("Connect wallet to comment.",true);
            return;
          }
          await addComment(tokenId, text);
        });
      }

      function loadChatMessages(tokenId, comments){
        const cm= document.getElementById("chatMessages");
        if(!cm) return;
        cm.innerHTML="";

        function renderCommentObj(c, level=0){
          const d= document.createElement("div");
          d.classList.add("chat-message");
          if(level>0) d.classList.add("chat-message-reply");
          d.innerHTML=`
            <div class="chat-message-header">
              <span>${c.user}</span>
              <span>${new Date(c.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="chat-message-content">${c.comment}</div>
            <button class="reply-button">Reply</button>
          `;
          const rBtn= d.querySelector(".reply-button");
          rBtn.addEventListener("click",()=>{
            if(!walletId){
              showNotification("Connect wallet to reply.",true);
              return;
            }
            const rep= prompt("Enter your reply:");
            if(!rep) return;
            if(!c.replies) c.replies=[];
            c.replies.push({
              user: walletId,
              comment: rep,
              timestamp:new Date(),
              replies:[]
            });
            loadChatMessages(tokenId, comments);
          });

          // nested replies
          if(c.replies && c.replies.length>0){
            c.replies.forEach(rep=>{
              d.appendChild(renderCommentObj(rep, level+1));
            });
          }
          return d;
        }

        comments.forEach(c=>{
          if(!c.replies) c.replies=[];
          cm.appendChild(renderCommentObj(c, 0));
        });
        cm.scrollTop= cm.scrollHeight;
      }

      function loadCommittedWallets(token){
        const div= document.getElementById("committedWallets");
        if(!div) return;
        div.innerHTML='<h4>Committed Wallets</h4>';
        if(!token.committedWallets || token.committedWallets.length===0){
          div.innerHTML+='<p>No commits yet.</p>';
          return;
        }
        token.committedWallets.forEach(entry=>{
          const line= document.createElement("p");
          line.textContent= `${entry.walletId} => ${entry.amount} SOL committed`;
          div.appendChild(line);
        });
      }

      async function addComment(tokenId, text){
        try{
          const res= await fetch(`/api/tokens/${tokenId}/comments`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ user:walletId, comment:text })
          });
          const data= await res.json();
          if(data.success){
            // update local
            const idx= tokens.findIndex(t=> t.id===tokenId);
            if(idx!==-1){
              tokens[idx].comments.push(data.comment);
            }
            showNotification("Comment added successfully!");
            loadChatMessages(tokenId, tokens[idx].comments);
            document.getElementById("chatInput").value="";
          } else {
            showNotification(data.message,true);
          }
        } catch(e){
          showNotification("Error adding comment.",true);
        }
      }

      /* COMMIT => from modal or immediate commit */
      closeCommitModal.addEventListener("click", ()=>{
        commitModal.style.display="none";
        currentPostId=null;
      });
      commitModal.querySelectorAll(".preset-btn").forEach(btn=>{
        btn.addEventListener("click", async e=>{
          e.stopPropagation();
          if(!walletId){
            showNotification("Please connect your wallet to commit.",true);
            return;
          }
          const amt= parseFloat(btn.dataset.amount);
          await commitSol(currentPostId, amt);
          commitModal.style.display="none";
          currentPostId=null;
        });
      });

      async function commitSol(tokenId, amount){
        try{
          const res= await fetch(`/api/tokens/${tokenId}/commit`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({walletId, amount})
          });
          const data= await res.json();
          if(data.success){
            const idx= tokens.findIndex(t=> t.id===tokenId);
            if(idx!==-1) tokens[idx]= data.token;
            userBalance= data.userBalance;
            showNotification(`Committed ${amount} SOL to ${data.token.title}.`);
            fetchTokens();
          } else {
            showNotification(data.message,true);
          }
        } catch(e){
          showNotification("Error committing SOL.",true);
        }
      }

      /* REFUND => partial if <100% funded, else not allowed */
      async function refundSol(tokenId){
        try{
          const res= await fetch(`/api/tokens/${tokenId}/refund`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ walletId })
          });
          const data= await res.json();
          if(data.success){
            const idx= tokens.findIndex(t=> t.id===tokenId);
            if(idx!==-1) tokens[idx]= data.token;
            showNotification(`Refunded ${data.refunded} SOL (Fee: ${data.fee}).`);
            fetchTokens();
          } else {
            showNotification(data.message,true);
          }
        } catch(e){
          showNotification("Error requesting refund.",true);
        }
      }

      /* UPVOTE */
      async function upvoteToken(tokenId){
        try{
          const res= await fetch(`/api/tokens/${tokenId}/upvote`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({walletId})
          });
          const data= await res.json();
          if(data.success){
            const idx= tokens.findIndex(t=> t.id===tokenId);
            if(idx!==-1) tokens[idx]= data.token;
            showNotification(data.message);
            fetchTokens();
          } else {
            showNotification(data.message,true);
          }
        } catch(e){
          showNotification("Error upvoting token.",true);
        }
      }

      /* MIGRATED => load from tokens that have migrated==true + live stats */
      async function loadMigrated(){
        migratedContainer.innerHTML='<h2>Migrated Prebond Tokens</h2>';
        const migrated= tokens.filter(t=> t.migrated);
        if(migrated.length===0){
          migratedContainer.innerHTML+='<p>No migrated tokens yet.</p>';
          return;
        }
        migrated.forEach(tok=>{
          // mock stats
          const mc= (Math.random()*100000+1000).toFixed(0);
          const liq= (Math.random()*500+10).toFixed(2);
          const hold= (Math.random()*1000+100).toFixed(0);
          const vol= (Math.random()*5000+100).toFixed(2);
          const txCount= (Math.random()*1000+50).toFixed(0);

          const div= document.createElement("div");
          div.classList.add("migrated-item");
          div.innerHTML=`
            <div style="font-weight:600;font-size:1rem;margin-bottom:0.5rem;">
              ${tok.title} (${tok.ticker}) <span class="migrated-badge">★</span>
            </div>
            <div class="stats-line">Market Cap: $${mc}</div>
            <div class="stats-line">Liquidity: $${liq}</div>
            <div class="stats-line">Holders: ${hold}</div>
            <div class="stats-line">Volume (24h): $${vol}</div>
            <div class="stats-line">Tx Count: ${txCount}</div>
          `;
          div.addEventListener("click",()=> showPostModal(tok.id));
          migratedContainer.appendChild(div);
        });
      }

      /* TRENDING => top upvotes from /api/tokens/trending */
      async function loadTrending(){
        try{
          const res= await fetch("/api/tokens/trending");
          const data= await res.json();
          if(data.success){
            trendingContainer.innerHTML='<h2>Trending Tokens</h2>';
            data.trending.forEach((tok,i)=>{
              const d= document.createElement("div");
              d.classList.add("trending-item");
              d.innerHTML=`
                <div style="font-size:0.85rem;margin-bottom:0.3rem;">
                  #${i+1} • ${tok.upvotes} upvotes
                </div>
                <div style="font-weight:600;">${tok.title}</div>
                <div style="font-size:0.8rem;opacity:0.8;">
                  ${tok.ticker} • ${tok.views||0} views
                </div>
              `;
              d.addEventListener("click",()=> showPostModal(tok.id));
              trendingContainer.appendChild(d);
              requestAnimationFrame(()=>{ d.style.opacity='1';});
            });
          } else {
            showNotification("Failed to load trending tokens.",true);
          }
        } catch(e){
          showNotification("Error loading trending tokens.",true);
        }
      }

      /* AI Agents => open/close => fetch etc. */
      openAIAgentBtn.addEventListener("click", ()=>{
        if(!walletId){
          showNotification("Connect wallet first to manage AI Agents.",true);
          return;
        }
        aiAgentModal.style.display="flex";
        fetchAgents();
      });
      closeAIAgentModal.addEventListener("click", ()=>{
        aiAgentModal.style.display="none";
      });

      aiAgentCreationForm.addEventListener("submit", async e=>{
        e.preventDefault();
        const email= document.getElementById("agentEmail").value.trim();
        const username= document.getElementById("agentUsername").value.trim();
        const password= document.getElementById("agentPassword").value.trim();
        const character= document.getElementById("agentCharacter").value;
        if(!email||!username||!password||!character){
          showNotification("All fields required for AI agent",true);
          return;
        }
        try{
          const r= await fetch("/api/agents/create",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
              publicKey:walletId,
              email,username,password,character
            })
          });
          const d= await r.json();
          if(d.success){
            showNotification("AI Agent created!");
            aiAgentCreationForm.reset();
            fetchAgents();
          } else {
            showNotification(d.message,true);
          }
        } catch(e){
          showNotification("Error creating AI Agent.",true);
        }
      });
      closeAgentLogsModal.addEventListener("click", ()=>{
        agentLogsModal.style.display="none";
      });

      async function fetchAgents(){
        if(!walletId){
          agentsList.innerHTML="<p>Please connect your wallet to view AI Agents.</p>";
          return;
        }
        try{
          const r= await fetch(`/api/agents?publicKey=${walletId}`);
          const d= await r.json();
          if(d.success){
            renderAgents(d.agents);
          } else {
            showNotification("Failed to fetch AI Agents.",true);
          }
        } catch(e){
          showNotification("Error fetching AI Agents.",true);
        }
      }

      function renderAgents(arr){
        agentsList.innerHTML="";
        if(arr.length===0){
          agentsList.innerHTML="<p>No AI Agents found. Create one above!</p>";
          return;
        }
        arr.forEach(agent=>{
          const c= document.createElement("div");
          c.classList.add("agent-item");
          c.innerHTML=`
            <div class="agent-header">
              <div>
                <span class="status-indicator ${agent.running?"status-running":"status-stopped"}"></span>
                <span class="agent-name">${agent.username}</span>
              </div>
              <div class="agent-actions">
                <button class="start-btn ${agent.running?"hidden":""}" data-id="${agent.id}">Start</button>
                <button class="stop-btn ${agent.running?"":"hidden"}" data-id="${agent.id}">Stop</button>
                <button class="delete-btn" data-id="${agent.id}">Delete</button>
                <button class="view-logs-btn" data-id="${agent.id}">Logs</button>
              </div>
            </div>
            <div class="agent-character"><strong>Character:</strong> ${agent.character}</div>
          `;
          // start
          const sBtn= c.querySelector(".start-btn");
          if(sBtn){
            sBtn.addEventListener("click", async ev=>{
              ev.stopPropagation();
              await startAgent(agent.id);
            });
          }
          // stop
          const spBtn= c.querySelector(".stop-btn");
          if(spBtn){
            spBtn.addEventListener("click", async ev=>{
              ev.stopPropagation();
              await stopAgent(agent.id);
            });
          }
          // delete
          const dBtn= c.querySelector(".delete-btn");
          if(dBtn){
            dBtn.addEventListener("click", async ev=>{
              ev.stopPropagation();
              if(!confirm("Are you sure you want to delete this AI Agent?")) return;
              await deleteAgent(agent.id);
            });
          }
          // logs
          const lBtn= c.querySelector(".view-logs-btn");
          if(lBtn){
            lBtn.addEventListener("click", async ev=>{
              ev.stopPropagation();
              await viewAgentLogs(agent.id);
            });
          }
          agentsList.appendChild(c);
        });
      }

      async function startAgent(id){
        try{
          const r= await fetch("/api/agents/start",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({publicKey:walletId, agentId:id})
          });
          const d= await r.json();
          if(d.success){
            showNotification("AI Agent started!");
            fetchAgents();
          } else {
            showNotification(d.message,true);
          }
        } catch(e){
          showNotification("Error starting AI Agent.",true);
        }
      }

      async function stopAgent(id){
        try{
          const r= await fetch("/api/agents/stop",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({publicKey:walletId, agentId:id})
          });
          const d= await r.json();
          if(d.success){
            showNotification("AI Agent stopped!");
            fetchAgents();
          } else {
            showNotification(d.message,true);
          }
        } catch(e){
          showNotification("Error stopping AI Agent.",true);
        }
      }

      async function deleteAgent(id){
        try{
          const r= await fetch("/api/agents/delete",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({publicKey:walletId, agentId:id})
          });
          const d= await r.json();
          if(d.success){
            showNotification("AI Agent deleted!");
            fetchAgents();
          } else {
            showNotification(d.message,true);
          }
        } catch(e){
          showNotification("Error deleting AI Agent.",true);
        }
      }

      async function viewAgentLogs(id){
        try{
          const r= await fetch(`/api/agents/logs?publicKey=${walletId}&agentId=${id}`);
          const d= await r.json();
          if(d.success){
            agentLogs.innerHTML="";
            if(d.logs.length===0){
              agentLogs.innerHTML="<p>No logs yet.</p>";
            } else {
              d.logs.forEach(l=>{
                const msg= document.createElement("div");
                msg.classList.add("chat-message");
                msg.innerHTML=`
                  <div class="chat-message-header">
                    <span>${l.type==='error'?'Error':'Output'}</span>
                    <span>${new Date(l.timestamp).toLocaleTimeString()}</span>
                  </div>
                  <div class="chat-message-content">${l.message}</div>
                `;
                agentLogs.appendChild(msg);
              });
              agentLogs.scrollTop= agentLogs.scrollHeight;
            }
            agentLogsModal.style.display="flex";
          } else {
            showNotification("Failed to fetch AI Agent logs.",true);
          }
        } catch(e){
          showNotification("Error fetching AI Agent logs.",true);
        }
      }

      // INIT
      function init(){
        // Always fetch tokens on page load so everything is visible
        fetchTokens();

        if(window.solana && window.solana.isPhantom && localStorage.getItem("walletId")){
          // Attempt to auto-connect if user is trusted
          window.solana.connect({onlyIfTrusted:true})
            .then(resp=>{
              walletId= resp.publicKey.toString();
              walletButton.textContent="Disconnect Wallet";
              showNotification("Wallet connected successfully!");
              fetchAgents();
              generateReferralLink();
            })
            .catch(()=>{
              // Even if Phantom is not trusted, we still show tokens
            });
        } else {
          // Not connected, but still fetch tokens so user sees them
          // (already called above)
        }
      }
      init();

      // close modals on outside click
      window.addEventListener("click", e=>{
        if(e.target===modal){
          modal.style.display="none";
        }
        if(e.target===commitModal){
          commitModal.style.display="none";
          currentPostId= null;
        }
        if(e.target===agentLogsModal){
          agentLogsModal.style.display="none";
        }
        if(e.target===aiAgentModal){
          aiAgentModal.style.display="none";
        }
      });
    });
  </script>
</body>
</html>
